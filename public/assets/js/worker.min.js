var db,storeCount=0,wc_api_url="/wc-api/v1/",ajaxLimit=1;addEventListener("message",function(a){var b=a.data;switch(b.cmd){case"sync":"undefined"!=typeof indexedDB&&openDB(),"undefined"!=typeof b.wc_api_url&&""!==b.wc_api_url&&(wc_api_url=b.wc_api_url),getUpdateCount(b.last_update);break;case"clear":deleteDB();break;case"stop":self.postMessage({status:"complete",msg:"Worker stopped: "+b.msg}),close();break;default:self.postMessage({status:"complete",msg:"Unknown command: "+b.cmd})}},!1);var getJSON=function(a,b,c){var d="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.open("get",a,!0),d.onreadystatechange=function(){var a,e;4===d.readyState&&(a=d.status,200===a?(e=JSON.parse(d.responseText),b&&b(e)):c&&c(a))},d.send()},openDB=function(){var a=indexedDB.open("productsDB");a.onupgradeneeded=function(){},a.onsuccess=function(a){db=a.target.result},a.onerror=function(a){self.postMessage({status:"error",msg:"Error: Couls not open local database."})}},getUpdateCount=function(a){a="undefined"!=typeof a?a:null;var b=["filter[updated_at_min]="+a,"pos=1"];getJSON(wc_api_url+"products/count?"+b.join("&"),function(b){b.count>0?(self.postMessage({status:"success",msg:b.count+" products need to be updated"}),b.count>1&&self.postMessage({status:"showModal",type:"downloadProgress",total:b.count}),queueProducts(b.count,ajaxLimit,a)):self.postMessage({status:"complete",msg:"0 products need to be updated"})},function(a){self.postMessage({status:"error",msg:a})})},queueProducts=function(a,b,c){a="undefined"!=typeof a?a:10,b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:null;for(var d=[],e=0;a>e;e+=b)d.push(storeProducts(a,b,e,c))},storeProducts=function(a,b,c,d){b="undefined"!=typeof b?b:100,c="undefined"!=typeof c?c:0,d="undefined"!=typeof d?d:null;var e=["filter[limit]="+b,"filter[offset]="+c,"filter[updated_at_min]="+d,"pos=1"];getJSON(wc_api_url+"products?"+e.join("&"),function(b){function c(){if(g<b.products.length){var d=f.put(b.products[g]);d.onsuccess=c,d.onerror=function(a){self.postMessage({status:"error",msg:"Problem saving "+a.target.result})},g++}else storeCount+=g,self.postMessage({status:"progress",count:storeCount}),storeCount===a&&self.postMessage({status:"complete",msg:"Sync complete!"})}if(null===b)return void self.postMessage({status:"error",msg:status});if("object"!=typeof db){var d=!1;return storeCount+=b.products.length,storeCount===a&&(d=!0),void self.postMessage({status:"noIndexedDB",products:b,last:d})}var e=db.transaction(["products"],"readwrite"),f=e.objectStore("products"),g=0;c()},function(a){self.postMessage({status:"error",msg:a})})};