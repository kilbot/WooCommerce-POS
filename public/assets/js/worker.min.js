var db,progress=0,wc_api_url="/wc-api/v1/",ajaxLimit=50;addEventListener("message",function(a){var b=a.data;switch(b.cmd){case"update":"undefined"!=typeof b.wc_api_url&&""!==b.wc_api_url&&(wc_api_url=b.wc_api_url),getUpdateCount(b.last_update);break;case"stop":postMessage({status:"notice",msg:"Worker stopped"}),close();break;default:postMessage({status:"complete",msg:"Unknown command: "+b.cmd})}},!1);var getJSON=function(a,b,c){var d="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.open("get",a,!0),d.onreadystatechange=function(){var a,e;if(4===d.readyState)if(a=d.status,200===a)try{e=JSON.parse(d.responseText),b&&b(e)}catch(f){c&&c(f)}else c&&c(a)},d.send()},getUpdateCount=function(a){a="undefined"!=typeof a?a:null;var b=["filter[updated_at_min]="+a,"pos=1"];getJSON(wc_api_url+"products/count?"+b.join("&"),function(b){b.count>0?(postMessage({status:"notice",msg:b.count+" products need to be updated"}),b.count>ajaxLimit&&postMessage({status:"modal",total:b.count}),getProducts(b.count,ajaxLimit,a)):postMessage({status:"products",products:[],progress:0,total:0})},function(){postMessage({status:"error",msg:wc_api_url+"products/count returned an error"})})},getProducts=function(a,b,c){a="undefined"!=typeof a?a:10,b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:null;var d=0,e=0,f=1e3;!function g(d,f){setTimeout(function(){var h=["filter[limit]="+b,"filter[offset]="+d,"filter[updated_at_min]="+c,"pos=1"];getJSON(wc_api_url+"products?"+h.join("&"),function(c){progress+=c.products.length,postMessage({status:"products",products:c.products,progress:progress,total:a}),next=d+b,next<a&&g(next)},function(a){503===a?++e<10?(f+=1e3,g(d,f),postMessage({status:"error",msg:"Failed to retrieve products, trying again ..."})):(postMessage({status:"error",msg:"Server down or overloaded"}),postMessage({status:"products",progress:progress,total:progress})):401===a?(postMessage({status:"error",msg:"Authentication error when retrieving products"}),postMessage({status:"products",progress:progress,total:progress})):(postMessage({status:"error",msg:"Server error when retrieving products"}),postMessage({status:"products",progress:progress,total:progress}))})},f)}(d,f)};