function searchFocus(){$("#filter input[type=search]").focus()}function tabIndexProducts(){$("#products > tbody > tr").each(function(a){$(".add-to-cart").attr("tabindex",a)})}!function(a){"use strict";a("#user-actions-btn, #user-actions").hover(function(){a("#user-actions").show()},function(){a("#user-actions").hide()}),searchFocus(),tabIndexProducts()}(jQuery),function(a){"use strict";function b(){a("#pagination").addClass("working");var b=!1,e=!1;g().then(function(a){return a.length>0?h(a):void 0}).then(function(){b=!0,i(b,e)});var f=m(l("last_update"));c(f).then(function(a){if(a>0){var b=10>a?a:10;return d(a,b,f)}}).then(function(){e=!0,i(b,e)})}function c(b){return b="undefined"!=typeof b?b:null,a.getJSON("/wc-api/v1/products/count",{"filter[updated_at_min]":b}).then(function(a){return console.log(a.count+" products need to be updated"),a.count},function(a,b,c){console.log("error "+b),console.log("incoming Text "+a.responseText),alert(c)})}function d(b,c,d){b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:10,d="undefined"!=typeof d?d:null;for(var f=[],g=0;b>g;g+=c)f.push(e(c,g,d));return console.log(f.length+" ajax calls queued"),a.when.apply(a,f).done(function(){console.log("All products retrieved and saved")})}function e(b,c,d){return console.log("getting "+b+" products, offset by "+c),b="undefined"!=typeof b?b:10,c="undefined"!=typeof c?c:0,d="undefined"!=typeof d?d:null,a.getJSON("/wc-api/v1/products/",{"filter[limit]":b,"filter[offset]":c,"filter[updated_at_min]":d}).then(function(a){f(a)},function(a){console.log(a)})}function f(a){console.log("saving "+a.products.length+" products");for(var b=0;b<a.products.length;b++){q.fullCollection.create(a.products[b],{merge:!0,success:function(a,b){console.log("saved: "+b.title)},error:function(a,b){console.log("error saving model: "+b.title)}})}}function g(){var b=a.getJSON(pos_cart_params.ajax_url,{action:"pos_get_product_ids"}).then(function(a){if(a instanceof Array){for(var b=q.fullCollection.models,c=[],d=0;d<b.length;d++)c.push(b[d].id);var e=_.difference(c,a);return console.log(e.length+" products need to be deleted"),e}console.log("server response is no good")},function(a,b,c){console.log("error "+b),console.log("incoming Text "+a.responseText),alert(c)});return b}function h(a){if(a instanceof Array){for(var b=0;b<a.length;b++){{var c=q.fullCollection.get(a[b]);c.destroy()}q.remove(c)}return void console.log(b+" products removed")}}function i(b,c){b&&c&&(console.log("sync is done! "),k("last_update",Date.now()),v.render(),a("#pagination").removeClass("working"))}function j(a){try{q.sync("closeall");var b=window.indexedDB.deleteDatabase(a.id);b.onsuccess=function(b){b.result;console.log("indexedDB: "+a.id+" deleted")},b.onerror=function(a){console.error("indexedDB.delete Error: "+a.message)},b.onblocked=function(a){console.error("indexedDB.delete Error: "+a.message)}}catch(c){console.error("Error: "+c.message)}}function k(a,b){return Modernizr.localstorage?(localStorage.setItem("posMeta-"+a,b),console.log("saved "+a+": "+b),!0):!1}function l(a){if(!Modernizr.localstorage)return!1;var b=localStorage.getItem("posMeta-"+a);return b}function m(a){var b=new Date(+a);if(b.getTime()>0){var c=new Date(b).getFullYear(),d=new Date(b).getMonth()+1,e=new Date(b).getDate();return 10>d&&(d="0"+d),10>e&&(e="0"+e),c+"-"+d+"-"+e}return null}var n={id:"productsDB",description:"Products database",migrations:[{version:"1.0",migrate:function(a,b){var c;a.db.objectStoreNames.contains("products")||(c=a.db.createObjectStore("products",{keyPath:"id"})),c=a.objectStore("products"),c.createIndex("titleIndex","title",{unique:!1}),b()}}]},o=Backbone.Model.extend({database:n,storeName:"products",initialize:function(){this.on("all",function(a){console.log(this.get("title")+" event: "+a)})}}),p=Backbone.PageableCollection.extend({database:n,storeName:"products",model:o,mode:"client",fields:"title",state:{pageSize:5,totalRecords:null},initialize:function(){this.on("all",function(a){console.log("Product Collection event: "+a)})}}),q=new p,r=Backbone.View.extend({tagName:"tr",model:new o,template:_.template(a("#tmpl-product").html()),initialize:function(){this.model.on("all",function(a){console.log("Product View event: "+a)})},render:function(){var a=this.model.toJSON();return this.$el.html(this.template(a)),this}}),s=Backbone.View.extend({el:a("#product-list"),tagName:"tbody",model:q,initialize:function(){this.model.on("all",function(a){console.log("Product List event: "+a)}),this.model.on("all",this.render,this),q.fetch().done(function(){console.log("init collection with "+q.length+" products from indexedDB")}),b()},render:function(){console.log("render the products");var a=this;return a.$el.html(""),_.each(this.model.toArray(),function(b){var c=new r({model:b});a.$el.append(c.render().$el)}),this}}),t=(new s,Backbone.View.extend({el:a("#filter"),collection:q,fields:["title"],events:{"keydown input[type=search]":"search",submit:function(a){a.preventDefault(),this.search()},"click a.clear":function(a){a.preventDefault(),this.clear()}},wait:149,initialize:function(){this._debounceMethods(["search","clear"]);var a=this.collection=this.collection.fullCollection||this.collection,b=this.shadowCollection=a.clone();this.listenTo(a,"add",function(a,c,d){b.add(a,d)}),this.listenTo(a,"remove",function(a,c,d){b.remove(a,d)}),this.listenTo(a,"sort",function(a){this.searchBox().val()||b.reset(a.models)}),this.listenTo(a,"reset",function(a,c){c=_.extend({reindex:!0},c||{}),c.reindex&&null==c.from&&null==c.to&&b.reset(a.models)})},_debounceMethods:function(a){_.isString(a)&&(a=[a]),this.undelegateEvents();for(var b=0,c=a.length;c>b;b++){var d=a[b],e=this[d];this[d]=_.debounce(e,this.wait)}this.delegateEvents()},makeRegExp:function(a){return new RegExp(a.trim().split(/\s+/).join("|"),"i")},makeMatcher:function(a){var b=this.makeRegExp(a);return function(a){for(var c=this.fields||a.keys(),d=0,e=c.length;e>d;d++)if(b.test(a.get(c[d])+""))return!0;return!1}},searchBox:function(){return this.$el.find("input[type=search]")},search:function(){this.showClearButtonMaybe();var a=_.bind(this.makeMatcher(this.searchBox().val()),this),b=this.collection;b.pageableCollection&&b.pageableCollection.getFirstPage({silent:!0}),b.reset(this.shadowCollection.filter(a),{reindex:!1})},clearButton:function(){return this.$el.find("a.clear")},clear:function(){this.clearSearchBox();var a=this.collection;a.pageableCollection&&a.pageableCollection.getFirstPage({silent:!0}),a.reset(this.shadowCollection.models,{reindex:!1})},clearSearchBox:function(){this.value=null,this.searchBox().val(null),this.showClearButtonMaybe()},showClearButtonMaybe:function(){var a=this.clearButton(),b=this.searchBox().val();b?a.show():a.hide()}})),u=(new t,Backbone.View.extend({el:a("#pagination"),tagName:"div",template:_.template(a("#tmpl-pagination").html()),initialize:function(){q.on("all",this.render,this),this.render()},events:{"click a.prev":"previous","click a.next":"next","click a.sync":"sync","click a.destroy":"destroy"},render:function(){var a=q.state;a.currentRecords=q.length;var b=new Date(+l("last_update"));return a.last_update=b.getTime()>0?b.toLocaleTimeString():"never",this.$el.html(this.template(a)),this.$el.prepend("<span></span> "),this},previous:function(){return q.hasPreviousPage()&&q.getPreviousPage(),!1},next:function(){return q.hasNextPage()&&q.getNextPage(),!1},sync:function(){return b(),!1},destroy:function(){return q.reset(),j(n),k("last_update",null),q.fetch(),!1}})),v=new u}(jQuery),function(a){"use strict";if("undefined"==typeof pos_cart_params)return console.log("No pos_cart_params"),!1;var b,c=Backbone.Model.extend({defaults:{qty:1,title:"",price:0,price_html:0,total:0,cart_item_key:""},idAttribute:"cart_item_key"}),d=Backbone.Collection.extend({model:c,url:pos_cart_params.ajax_url,parse:function(a){return console.log(a),this.setNonce(a.nonce),a.items},setNonce:function(a){b=a}}),e=Backbone.View.extend({tagName:"tr",template:a("#tmpl-cart-item").html(),initialize:function(){this.render(),this.model.on("add remove change",function(){this.render()},this)},events:{"click a.remove-from-cart":"removeFromCart","click .qty input":"edit","keypress .qty input":"updateOnEnter","blur .qty input":"close"},removeFromCart:function(c){"undefined"!=typeof c&&c.preventDefault(),this.$el.fadeOut(500,function(){a(this).remove()}),g.fetch({data:{action:"pos_remove_item",remove_item:this.model.get("cart_item_key"),_wpnonce:b},processData:!0,success:function(){mediator.publish("updateTotals")}})},edit:function(){this.$el.addClass("editing"),this.$(".qty input").attr("contenteditable",!0).focus()},close:function(){var a=this.$(".qty input").val();if(a!=this.model.get("qty"))return 0==a?(console.log("0 qty"),void this.removeFromCart()):void(a?(g.fetch({data:{action:"pos_update_cart",cart_item_key:this.model.get("cart_item_key"),qty:a},processData:!0,success:function(){mediator.publish("updateTotals")}}),this.$el.removeClass("editing"),this.$(".qty input").removeAttr("contenteditable")):this.$(".qty input").attr("contenteditable",!0).focus())},updateOnEnter:function(a){13==a.keyCode&&this.close(),_.delay(function(){self.$(".qty button").blur(),100})},render:function(){return this.$el.html(_.template(this.template,this.model.toJSON())),this}}),f=Backbone.View.extend({el:a("#cart-items"),tagName:"tbody",initialize:function(){this.on("all",function(a){console.log("Items View event: "+a)}),this.collection=g,this.defaultMessage(),this.collection.on("add change",function(){this.render()},this)},addToCart:function(a,b){g.fetch({data:{action:"pos_add_to_cart",add_to_cart:a,variation_id:b},processData:!0,success:function(){mediator.publish("updateTotals")}})},defaultMessage:function(){},render:function(){this.$el.html(""),this.collection.each(function(a){var b=new e({model:a});this.$el.append(b.render().el)},this)}});console.log("init cart items");var g=new d;g.fetch({data:{action:"pos_get_cart_items"},processData:!0});var h=new f;mediator.subscribe("addToCart",function(a){var b=a.get("id"),c="";"variation"===a.get("type")&&(b=a.get("parent_id"),c=a.get("id")),h.addToCart(b,c)});var i=Backbone.Model.extend({defaults:{title:"Total",total:"0.00"}}),j=Backbone.Collection.extend({model:i,url:pos_cart_params.ajax_url,parse:function(a){return console.log(a),a.totals}}),k=Backbone.View.extend({tagName:"tr",template:a("#tmpl-cart-total").html(),initialize:function(){this.render(),this.model.on("add",function(){this.render()},this)},render:function(){return this.$el.html(_.template(this.template,this.model.toJSON())),this}}),l=Backbone.View.extend({el:a("#cart-totals"),tagName:"tfoot",initialize:function(){this.collection=m,this.render(),this.collection.on("add change update",function(){this.render()},this)},render:function(){this.$el.html(""),this.collection.each(function(a){if(0!=a.get("total")||""!=a.get("total")){var b=new k({model:a});this.$el.append(b.render().el)}},this)}});console.log("init cart totals");var m=new j;m.fetch({data:{action:"pos_get_cart_totals"},processData:!0});new l;mediator.subscribe("updateTotals",function(){m.fetch({data:{action:"pos_get_cart_totals"},processData:!0})})}(jQuery),function(a){"use strict";a("button.btn-checkout").click(function(b){b.preventDefault();var c={action:"pos_process_order"};a.post(pos_cart_params.ajax_url,c,function(b){return b?b.error?void console.log(b.error):void a("#cart").html(b):void console.log("No response from server")})})}(jQuery);
//# sourceMappingURL=map/pos.map