_.extend(Marionette.Application.prototype,{debugLog:function(a,b){_.isUndefined(this.debug)&&(this.debug=localStorage.getItem("wc_pos_debug")?!0:!1,Backbone.Radio.DEBUG=this.debug,console.info("Debugging is "+(this.debug?"on":"off")+", visit http://woopos.com.au/docs/debugging")),this.debug&&console[a](b)},navigate:function(a,b){b||(b={}),Backbone.history.navigate(a,b)},getCurrentRoute:function(){var a=Backbone.history.fragment;return _.isEmpty(a)?null:a},startHistory:function(){return Backbone.history?Backbone.history.start():void 0},register:function(a,b){return this._registry||(this._registry={}),this._registry[b]=a},unregister:function(a,b){return delete this._registry[b]},resetRegistry:function(){var a,b,c,d,e;d=this.getRegistrySize(),e=this._registry;for(b in e)a=e[b],a.region.close();return c="There were "+d+" controllers in the registry, there are now "+this.getRegistrySize(),this.getRegistrySize()>0?console.warn(c,this._registry):console.log(c)},getRegistrySize:function(){return _.size(this._registry)}}),_.extend(Marionette.Region.prototype,{twoColumns:function(){POS.debugLog("log","Init two column layout");var a=Marionette.LayoutView.extend({template:_.template('<div id="left"></div><div id="right"></div>'),regions:{leftRegion:"#left",rightRegion:"#right"}}),b=new a;return this.listenTo(b,"show",function(){this.$el.addClass("two-column"),this.addTabs(b)}),b},addTabs:function(){var a=POS.Components.Tabs.channel.request("get:tabs",[{value:"left"},{value:"right"}]);this.listenTo(a.collection,"change:active",function(a){this.$el.removeClass("left-active right-active").addClass(a.id+"-active")}),POS.channel.comply("update:tab:label",function(b,c){a.collection.get(c).set({label:b})}),a.collection.get("left").set({active:!0}),POS.layout.tabsRegion.show(a),this.on("empty",function(){this.$el.removeClass("two-column left-active right-active"),POS.layout.tabsRegion.empty()})}}),_.extend(FilteredCollection.prototype,{query:function(a,b){b||(b="search");var c=POS.Components.SearchParser.channel.request("facets",a);this.checkCriterion(c),console.log(c),this.filterBy(b,_.partial(this.matchMaker,c))},matchMaker:function(a,b){return _.all(a,function(a,c){return""===c?_.all(a,function(a){var c=_.pick(b.attributes,b.fields);return _.any(_.values(c),function(b){return-1!==b.toLowerCase().indexOf(a)})}):"cat"===c?_.any(a,function(a){var c=_(b.get("categories")).map(function(a){return a.toLowerCase()});return _(c).contains(a)}):_(b.attributes).has(c)?_(b.get(c)).isArray()?_.any(a,function(a){var d=_(b.get(c)).map(function(a){return a});return _(d).contains(a)}):_.any(a,function(a){return b.get(c).toString().toLowerCase()===a}):!1},this)},checkCriterion:function(a){this.superset()instanceof POS.Entities.Products&&(_(a).has("parent")?(this.removeFilter("hideVariations"),a.type=["variation"]):this.hideVariations(),_(a).has("barcode")&&this.barcodeSearch(a.barcode))},hideVariations:function(){this.filterBy("hideVariations",function(a){return"variation"!==a.get("type")})},barcodeSearch:function(){}});var RootView=Marionette.LayoutView.extend({el:"#page",template:_.template($("#page").html()),regions:{headerRegion:"#header",menuRegion:"#menu",tabsRegion:"#tabs",mainRegion:"#main",modalRegion:"#modal"}}),POS=new Marionette.Application({initialize:function(){this.layout=new RootView,this.layout.render()}});Marionette.Behaviors.getBehaviorClass=function(a,b){return POS.Components[b].Behavior},POS.channel.reply("default:region",function(){return POS.layout.mainRegion}),POS.channel.comply("register:instance",function(a,b){return POS.register(a,b)}),POS.channel.comply("unregister:instance",function(a,b){return POS.unregister(a,b)}),POS.module("Entities",function(a){a.channel=Backbone.Radio.channel("entities")}),POS.on("before:start",function(a){this.options=a,accounting.settings=this.options.accounting}),POS.on("start",function(){POS.startHistory(),POS.HeaderApp.start()}),POS.Controller=POS.Controller||{},POS.Controller.Base=Marionette.Controller.extend({constructor:function(a){return a||(a={}),this.region=a.region||POS.channel.request("default:region"),this._instance_id=_.uniqueId("controller"),POS.channel.command("register:instance",this,this._instance_id),Marionette.Controller.prototype.constructor.apply(this,arguments)},destroy:function(){return POS.channel.command("unregister:instance",this,this._instance_id),Marionette.Controller.prototype.destroy.apply(this,arguments)},show:function(a,b){b||(b={}),_.defaults(b,{loading:!1,region:this.region}),this._setMainView(a),this._manageView(a,b)},_setMainView:function(a){this._mainView||(this._mainView=a,this.listenTo(a,"destroy",this.destroy))},_manageView:function(a,b){return b.loading?POS.Components.Loading.channel.command("show:loading",a,b):void b.region.show(a)}}),POS.View=POS.View||{},POS.View.Form=Marionette.ItemView.extend({constructor:function(a){return a||(a={}),Marionette.ItemView.prototype.constructor.apply(this,arguments)},bindings:{},render:function(){var a=Array.prototype.slice.apply(arguments),b=Marionette.ItemView.prototype.render.apply(this,a);return Backbone.Validation.bind(this,{model:this.model,valid:function(a,b){a.$('input[name="'+b+'"]').parent().removeClass("error")},invalid:function(a,b){a.$('input[name="'+b+'"]').parent().addClass("error")}}),this.stickit(),b},remove:function(){return Backbone.Validation.unbind(this),Backbone.View.prototype.remove.apply(this,arguments)}}),Backbone.$.wc_pos_ajax=function(a){return _.merge(a,{url:POS.ajaxurl,data:{security:POS.nonce},beforeSend:function(a){a.setRequestHeader("X-WC-POS",1)}}),Backbone.$.ajax(a)},POS.Utils={round:function(a,b){return void 0===b&&(b=accounting.settings.number.precision),parseFloat(accounting.toFixed(a,b))},unformat:function(a){return accounting.unformat(a,accounting.settings.number.decimal)},formatNumber:function(a,b){return void 0===b&&(b=accounting.settings.number.precision),"auto"===b&&(b=(+a).toFixed(4).replace(/^-?\d*\.?|0+$/g,"").length),accounting.formatNumber(a,b)},isPositiveInteger:function(a,b){var c=~~Number(a);return b?String(c)===a&&c>=0:String(c)===a&&c>0},parseErrorResponse:function(a){var b=a.responseJSON;return b.errors?b.errors[0].message:a.responseText}},Handlebars.registerHelper("is",function(a,b,c){return _(b.split("|")).contains(a)?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("compare",function(a,b,c,d){if(arguments.length<3)throw new Error('Handlerbars Helper "compare" needs 2 parameters');void 0===d&&(d=c,c=b,b="===");var e={"==":function(a,b){return a==b},"===":function(a,b){return a===b},"!=":function(a,b){return a!=b},"!==":function(a,b){return a!==b},"<":function(a,b){return b>a},">":function(a,b){return a>b},"<=":function(a,b){return b>=a},">=":function(a,b){return a>=b},"typeof":function(a,b){return typeof a==b}};if(!e[b])throw new Error('Handlerbars Helper "compare" doesn\'t know the operator '+b);var f=e[b](a,c);return f?d.fn(this):d.inverse(this)}),Handlebars.registerHelper("csv",function(a,b){return b.fn(a.join(", "))}),Handlebars.registerHelper("money",function(a,b){var c=b.hash.precision;return void 0===c&&(c=accounting.settings.currency.precision),"auto"===c&&(c=(+a).toFixed(4).replace(/^-?\d*\.?|0+$/g,"").length),a=POS.Utils.round(a,c),b.hash.negative&&(a=-1*a),accounting.formatMoney(a)}),Handlebars.registerHelper("number",function(a,b){var c=b.hash.precision;return void 0===c&&(c=accounting.settings.number.precision),"auto"===c&&(c=(+a).toFixed(4).replace(/^-?\d*\.?|0+$/g,"").length),b.hash.negative&&(a=-1*a),accounting.formatNumber(a,c)}),Handlebars.registerHelper("formatAddress",function(a,b){var c="";return(a.first_name||a.last_name)&&(c+=a.first_name+" "+a.last_name+"<br>"),a.company&&(c+=a.company+"<br>"),a.address_1&&(c+=a.address_1+"<br>"),a.address_2&&(c+=a.address_2+"<br>"),(a.city||a.state||a.postcode)&&(c+=a.city+" "+a.state+" "+a.postcode),c&&b.hash.title&&(c="<h3>"+b.hash.title+"</h3>"+c),new Handlebars.SafeString(c)}),Handlebars.registerHelper("formatDate",function(a,b){var c=b.hash.format||"";return moment(a).format(c)}),Handlebars.registerHelper("getOption",function(a){for(var b=a.split("."),c=POS.getOption(b.shift()),d=0;d<b.length;d++)c=c[b[d]];return c}),Backbone.Stickit.addHandler({selector:'input[data-numpad="discount"]',onGet:POS.Utils.formatNumber,onSet:POS.Utils.unformat,events:["blur"],afterUpdate:function(a){a.trigger("input")}}),Backbone.Stickit.addHandler({selector:'input[data-numpad="quantity"]',onGet:POS.Utils.formatNumber,onSet:POS.Utils.unformat,events:["blur"],afterUpdate:function(a){a.trigger("input")}}),Backbone.Stickit.addHandler({selector:'input[data-handler="address"]',onGet:function(a,b){var c=b.selector.match(/\w+\[(\w+)\]/)[1];return _(a).has(c)?a[c]:""},onSet:function(a,b){var c=b.selector.match(/\w+\[(\w+)\]/)[1],d=b.view.model.get(b.observe);return d||(d={}),d[c]=a,d}}),POS.module("Entities",function(a,b,c,d,e,f){a.Product=c.DualModel.extend({idAttribute:"local_id",remoteIdAttribute:"id",fields:["title"],parse:function(a){return a.product&&"variable"===a.product&&this.serverResponse(a),a.product?a.product:a},serverResponse:function(a){f.each(a.product.variations,function(b){b.type="variation",b.title=a.product.title,b.parent=a.product.id,b.categories=a.product.categories,a.product.push(b)})}}),a.Products=c.DualCollection.extend({model:a.Product,url:function(){return b.getOption("wc_api")+"products"},initialize:function(){this.indexedDB=new c.IndexedDB({storeName:"products",storePrefix:"wc_pos_",dualStorage:!0,dbVersion:1,keyPath:"local_id",autoIncrement:!0,indexes:[{name:"local_id",keyPath:"local_id",unique:!0},{name:"id",keyPath:"id",unique:!0},{name:"status",keyPath:"status",unique:!1}]},this),this.on("remote:sync",this.remoteSync)},state:{pageSize:10},parseState:function(a,b,c,d){var e=parseInt(d.xhr.getResponseHeader("X-WC-Total")),f=parseInt(d.xhr.getResponseHeader("X-WC-TotalPages"));return{totalRecords:e,totalPages:f}},parse:function(a){return a.products&&this.serverResponse(a),a.products?a.products:a},serverResponse:function(a){var b=f.where(a.products,{type:"variable"});f.each(b,function(b){f.each(b.variations,function(c){c.type="variation",c.title=b.title,c.parent=b.id,c.categories=b.categories,a.products.push(c)})})},remoteSync:function(){this.fullSync().done(function(){}).fail(function(a,c){var d=b.Utils.parseErrorResponse(c);b.Components.Alerts.channel.command("open:alert",{type:"danger",title:a.title,message:d})})}}),a.channel.reply("products",function(){return new a.Products})}),POS.module("Entities",function(a){a.channel.reply("order",function(b){return new a.Orders.Model(b)}),a.channel.reply("orders",function(){return new a.Orders.Collection})}),POS.module("Entities.Orders",function(a,b,c){a.Model=c.DualModel.extend({idAttribute:"local_id",remoteIdAttribute:"id",defaults:{note:""}})}),POS.module("Entities.Orders",function(a,b,c,d,e,f){a.Collection=c.DualCollection.extend({model:a.Model,url:function(){return b.getOption("wc_api")+"orders"},initialize:function(){this.indexedDB=new c.IndexedDB({storeName:"orders",storePrefix:"wc_pos_",dualStorage:!0,dbVersion:1,keyPath:"local_id",autoIncrement:!0,indexes:[{name:"local_id",keyPath:"local_id",unique:!0},{name:"id",keyPath:"id",unique:!0},{name:"status",keyPath:"status",unique:!1}]},this)},parse:function(a){return a.orders?a.orders:a},fetchLocalOrders:function(){var a=this,b=function(b){f(b).has("id")||a.add(b)},c=function(){a.trigger("orders:ready")};a.indexedDB.iterate(b,{index:"local_id",order:"ASC",onEnd:c})}})}),POS.module("Entities",function(a){a.channel.reply("cart",function(b){return new a.Cart.Collection([],b)})}),POS.module("Entities.Cart",function(a,b,c,d,e,f){a.Model=c.Model.extend({defaults:{subtotal:0,subtotal_tax:0,total_tax:0,total:0,item_price:0,item_tax:0,qty:1,taxable:!0,tax_class:""},initialize:function(){this.collection&&this.collection.order&&this.set({order:this.collection.order.id}),this.on("change:qty change:item_price change:taxable change:tax_class",this.updateLineTotals),0===this.get("item_price")&&this.set({item_price:parseFloat(this.get("price"))})},updateLineTotals:function(){console.log("recalc");var a=this.get("qty"),c=this.get("item_price"),d=this.get("type"),e=parseFloat(this.get("regular_price")),f=this.calcTax(e),g=this.calcTax(c,a);("shipping"===d||"fee"===d)&&(e=c),"yes"===b.getOption("tax").prices_include_tax&&(e-=f,c-=g),this.save({item_subtotal:e,item_subtotal_tax:f,item_tax:b.Utils.round(g,4),subtotal:b.Utils.round(e*a,4),subtotal_tax:b.Utils.round(f*a,4),total_tax:b.Utils.round(g*a,4),total:b.Utils.round(c*a,4)})},calcTax:function(a,c){var d=0,e=this.get("tax_class"),f=b.getOption("tax_rates"),g=f[e];return"yes"===b.getOption("tax").calc_taxes&&this.get("taxable")&&g&&(d="yes"===b.getOption("tax").prices_include_tax?this.calcInclusiveTax(a,g,c):this.calcExclusiveTax(a,g,c)),d},calcInclusiveTax:function(a,c,d){var e=0,g=0,h=0,i=0,j=0;if(void 0===d){var k=!0;d=1}f(c).each(function(a){"yes"===a.compound?g+=parseFloat(a.rate):e+=parseFloat(a.rate)});var l=1+e/100,m=1+g/100;return h=a/m,f(c).each(function(c,e){var f=parseFloat(c.rate)/100,g=0;"yes"===c.compound?(g=a,f/=m):(g=h,f/=l);var n=a-f*g;i=a-n;var o=b.Utils.round(i,4),p=b.Utils.round(i*d,4);this.set("item_tax_"+e,o),this.set("line_tax_"+e,p),c.tax_amount=p,j+=o,k&&(c.subtotal_tax=o)},this),b.Utils.round(j,4)},calcExclusiveTax:function(a,c,d){var e=[],g=0,h=0,i=0;if(void 0===d){var j=!0;d=1}return f(c).each(function(b,c){h=0,"yes"!==b.compound&&(h=a*(parseFloat(b.rate)/100)),e[c]=h}),e.length>0&&(g=e.reduce(function(a,b){return a+b})),f(c).each(function(c,f){if("yes"===c.compound){var h=a+g;e[f]=h*(parseFloat(c.rate)/100)}var k=b.Utils.round(e[f],4),l=b.Utils.round(e[f]*d,4);this.set("item_tax_"+f,k),this.set("line_tax_"+f,l),c.tax_amount=l,i+=k,j&&(c.subtotal_tax=k)},this),b.Utils.round(i,4)},quantity:function(a){var b=this.get("qty");this.set("qty","increase"===a?++b:--b)}})}),POS.module("Entities.Cart",function(a,b,c,d,e,f){a.Collection=c.Collection.extend({model:a.Model,comparator:function(a){var b=a.get("type");return"fee"===b?2:"shipping"===b?1:0},initialize:function(a,b){b=b||{},this.indexedDB=new c.IndexedDB({storeName:"cart",storePrefix:"wc_pos_",dbVersion:1,keyPath:"local_id",autoIncrement:!0,indexes:[{name:"order",keyPath:"order",unique:!1},{name:"type",keyPath:"type",unique:!1}]},this),b.order&&(this.order=b.order),this.on("add remove change",this.calcTotals)},calcTotals:function(){var a,c,d,e=0;a=f(this.pluck("subtotal")).reduce(function(a,b){return a+b},0),c=f(this.pluck("subtotal_tax")).reduce(function(a,b){return a+b},0),d=f(this.pluck("total")).reduce(function(a,b){return a+b},0),"yes"===b.getOption("tax").calc_taxes&&(e=f(this.pluck("total_tax")).reduce(function(a,b){return a+b},0));var g={total:b.Utils.round(d,4),subtotal:b.Utils.round(a,4),subtotal_tax:b.Utils.round(c,4),cart_discount:b.Utils.round(a-d,4),total_tax:b.Utils.round(e,4)};this.order&&this.order.save(g)},fetchOrder:function(){var a=this,b=function(b){b.order===a.order.id&&a.add(b)},c=function(){a.trigger("cart:ready")};a.indexedDB.iterate(b,{index:"order",order:"ASC",onEnd:c})}})}),POS.module("Entities.Settings",function(a,b,c,d,e,f){a.Usermeta=c.Collection.extend({initialize:function(a,b){this.id=b.id},save:function(){var a=this.toJSON(),c={id:this.id,action:"wc_pos_user_settings",security:b.nonce,data:a[0]};e.post(b.ajaxurl,c,function(a){console.log(a)})}}),a.Option=c.Model.extend({initialize:function(){this.url=b.ajaxurl,this._saving=!1},sync:function(a,d,e){var g="id="+d.get("id"),h="action=wc_pos_admin_settings",i="security="+b.nonce;e.emulateHTTP=!0,e.url=d.url+"?"+h+"&"+g+"&"+i;var j={beforeSend:function(){this.trigger("update:start"),this._saving=!0},complete:function(){this.trigger("update:stop"),this._saving=!1}};return this._saving||"update"!==a||f.defaults(e,{beforeSend:f.bind(j.beforeSend,d),complete:f.bind(j.complete,d)}),c.sync(a,d,e)}}),a.Options=c.Collection.extend({model:a.Option}),b.Entities.channel.reply("hotkeys",function(){return new a.Usermeta(b.getOption("hotkeys"),{id:"hotkeys"})}),b.Entities.channel.reply("options",function(b){return new a.Options([],b)})}),POS.module("Components.HotKeys",function(a,b,c,d,e,f){a.Behavior=d.Behavior.extend({initialize:function(){var a=b.Entities.channel.request("hotkeys");f.each(this.view.keyEvents,function(c,d){var f=a.get(d);f?e(document).bind("keydown",f.get("key"),this.view[c]):b.debugLog("warn","Hotkey not found, id: "+d)},this)},onClose:function(){f.each(this.view.keyEvents,function(a){e(document).unbind("keydown",this.view[a])},this)}})}),POS.module("Components.Loading",function(a,b,c,d,e,f){a.channel=c.Radio.channel("loading"),a.channel.comply("show:loading",function(b,c){return new a.Controller({view:b,region:c.region,config:c.loading})}),a.Controller=b.Controller.Base.extend({initialize:function(b){var c=b.view,d=b.config;switch(d=f.isBoolean(d)?{}:d,f.defaults(d,{loadingType:"spinner",loadingMessage:""}),d.loadingType){case"spinner":var e=new a.Spinner({message:d.loadingMessage});this.show(e);break;case"opacity":this.region.currentView.$el.css({opacity:.5});break;default:throw new Error("Invalid loadingType")}this.showRealView(c,e,d)},showRealView:function(a,c,d){var g=this,h=d.entities;f.isArray(h)||(h=[d.entities]),e.when.apply(e,h).done(function(){switch(d.loadingType){case"spinner":if(g.region.currentView!==c)return a.close();break;case"opacity":g.region.currentView.$el.removeAttr("style")}g.show(a)}).fail(function(a,d,e){b.debugLog("error",e),c.fail(d)})}})}),POS.module("Components.Loading",function(a,b,c,d,e,f){a.Spinner=d.ItemView.extend({className:"loading",initialize:function(){this.on("update:message",this.render),this.timeout=setTimeout(f.bind(this.fail,this),6e4)},render:function(){var a="";return f.isEmpty(this.options.message)||(a="<p>"+this.options.message+"</p>"),this.$el.html('<p><i class="icon icon-spinner icon-lg"></i></p>'+a),this},onBeforeDestroy:function(){clearTimeout(this.timeout)},fail:function(a){this.options.message=a?a:"Script Error",this.render(),this.$(".icon").removeClass("icon-spinner").addClass("icon-fail")}})}),POS.module("Components.Modal",function(a,b,c,d,e,f){b.addInitializer(function(){new a.Controller({container:b.layout.modalRegion})}),a.channel=c.Radio.channel("modal"),a.Controller=d.Controller.extend({initialize:function(b){this.container=b.container,this.view=new a.View,this.container.show(this.view),f.bindAll(this,"openModal","closeModal"),a.channel.comply("open",this.openModal),a.channel.comply("close",this.closeModal)},openModal:function(a){this.view.openModal(a)},closeModal:function(a){this.view.closeModal(a)}})}),POS.module("Components.Modal",function(a,b,c,d,e,f){a.View=d.LayoutView.extend({template:"#tmpl-modal",className:"modal",attributes:{tabindex:-1,role:"dialog"},regions:{content:".modal-body"},events:{"click .action-close":"closeModal","click .action-save":"saving","click .modal-footer a":"onButtonClick"},initialize:function(){this.$el.modal({show:!1})},onButtonClick:function(a){a.preventDefault(),this.content.currentView.trigger("button:clicked",a)},triggers:{"show.bs.modal":{preventDefault:!1,event:"show:modal"},"shown.bs.modal":{preventDefault:!1,event:"after:show:modal"},"hide.bs.modal":{preventDefault:!1,event:"hide:modal"},"hidden.bs.modal":{preventDefault:!1,event:"after:hide:modal"}},openModal:function(a){this.once("after:show:modal",a.callback),this.setupModal(a),this.$el.modal("show")},closeModal:function(a){this.once("after:hide:modal",a.callback),this.once("after:hide:modal",this.teardownModal),this.$el.modal("hide")},setupModal:function(a){this.isShown&&this.teardownModal(),a.attributes&&(a.attributes.class&&this.$(".modal-dialog").addClass(a.attributes.class),a.attributes.title&&this.$(".modal-header h1").html(a.attributes.title)),this.content.show(a.view),this.isShown=!0,a.view.model&&this.listenTo(a.view.model,"save:status",this.updateSaveStatus)},teardownModal:function(){this.isShown&&(this.content.empty(),this.render(),this.isShown=!1)},saving:function(){this.$(".modal-footer .action-save").addClass("disabled"),this.$(".modal-footer p.response").removeClass("success error").html('<i class="icon icon-spinner"></i>')},updateSaveStatus:function(a,b){f.isUndefined(b)&&(b=this.$(".modal-footer p.response").data(a)),this.$(".modal-footer p.response").addClass(a).html('<i class="icon icon-'+a+'"></i> '+b),this.$(".modal-footer .action-save").removeClass("disabled")}})}),POS.module("Components.Modal",function(a,b,c,d){a.Behavior=d.Behavior.extend({initialize:function(){this.listenToOnce(this.view,"modal:open",this.openModal)},openModal:function(b){this.view.title&&(this.options.title=this.view.title),a.channel.command("open",{view:this.view,callback:b,attributes:this.options}),this.listenToOnce(this.view,"modal:close",this.closeModal)},closeModal:function(b){a.channel.command("close",{callback:b})}})}),POS.module("Components.Popover",function(a,b,c,d,e,f){a.channel=c.Radio.channel("popover"),a.Controller=d.Controller.extend({initialize:function(){f.bindAll(this,"openPopover","closePopover"),a.channel.comply("open",this.openPopover),a.channel.comply("close",this.closePopover)},openPopover:function(b){this.view=new a.View(b),this.view.openPopover(b)},closePopover:function(a){this.view.closePopover(a)}}),new a.Controller}),POS.module("Components.Popover",function(a,b,c,d,e,f){a.View=d.LayoutView.extend({template:f.template('<div class="arrow"></div><div class="popover-region"><h3 class="popover-title"></h3><div class="popover-content"></div></div>'),className:"popover",attributes:{role:"tooltip"},regions:{content:".popover-region"},initialize:function(a){this.render();var b=this;a.target.on("show.bs.popover",function(){b.trigger("after:show:popover",b)}),a.target.on("hide.bs.popover",function(){b.trigger("after:hide:popover",b)}),a.target.on("close:popover",function(a){b.closePopover({target:e(a.target)})})},openPopover:function(a){this.once("after:show:popover",a.callback),this.setupPopover(a),a.target.popover("show")},closePopover:function(a){this.once("after:hide:popover",a.callback),this.once("after:hide:popover",this.teardownPopover),a.target.popover("destroy")},setupPopover:function(a){var b=f.clone(a)||{};f.defaults(b,{html:!0,container:"body",placement:"bottom",trigger:"manual",template:this.el}),a.target.popover(b)},teardownPopover:function(){this.content&&this.content.empty(),this.destroy()}})}),POS.module("Components.Popover",function(a,b,c,d){a.Behavior=d.Behavior.extend({initialize:function(){this.listenTo(this.view,"popover:open",this.openPopover)},openPopover:function(b,c){a.channel.command("open",{target:b,callback:c}),this.listenTo(this.view,"popover:close",this.closePopover)},closePopover:function(b,c){a.channel.command("close",{target:b,callback:c})}})}),POS.module("Components.Tooltip",function(a,b,c,d,e,f){a.Behavior=d.Behavior.extend({initialize:function(a){this.options=f.defaults(a,{})},ui:{tooltip:'*[data-toggle="tooltip"]'},onRender:function(){this.ui.tooltip.tooltip(this.options)},onBeforeDestroy:function(){this.ui.tooltip.tooltip("destroy")}})}),POS.module("Components.Filter",function(a,b,c,d,e,f){a.Behavior=d.Behavior.extend({ui:{searchField:"input[type=search]",clearBtn:"a.clear"},events:{"keyup @ui.searchField":"query","click @ui.clearBtn":"clear"},query:f.debounce(function(){this.showClearButtonMaybe(),this.view.trigger("search:query",this.ui.searchField.val())},149),clear:function(a){a.preventDefault(),this.view.collection.removeFilter("search"),this.ui.searchField.val(""),this.showClearButtonMaybe()},showClearButtonMaybe:function(){f.isEmpty(this.ui.searchField.val())?this.ui.clearBtn.hide():this.ui.clearBtn.show()}})}),POS.module("Components.AutoGrow",function(a,b,c,d,e,f){a.Behavior=d.Behavior.extend({initialize:function(a){this.options=a||(a={}),f.defaults(this.options,{padding:20}),this.tester=e("#autogrow-tester"),0===this.tester.length&&(this.tester=e('<div id="autogrow-tester" />').css({opacity:0,top:-9999,left:-9999,position:"absolute",whiteSpace:"nowrap"}),e("body").append(this.tester)),this.listenTo(this.view,"show render",this.autoGrowEach)},ui:{input:".autogrow"},events:{"input @ui.input":"autoGrow"},autoGrowEach:function(){f.each(this.ui.input,function(a){this.autoGrow(e(a))},this)},autoGrow:function(a){var b=a.target?e(a.target):a,c=b.val();c=c.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),this.tester.html(c);var d=this.tester.width()+this.options.padding;b.css({width:d})}})}),POS.module("Components.Tabs",function(a,b,c){a.channel=c.Radio.channel("tabs"),a.channel.reply("get:tabs",function(b){var c=new a.Collection(b),d=new a.View({collection:c});return d})}),POS.module("Components.Tabs",function(a,b,c,d){a.ItemView=d.ItemView.extend({tagName:"li",initialize:function(){this.template=Handlebars.compile('{{#unless fixed}}<a href="#"><i class="icon icon-times-circle action-remove"></i></a>{{/unless}}{{{ label }}}')},className:function(){return this.model.get("active")?"active":void 0},triggers:{click:"tab:clicked","click .action-remove":"tab:removed"},onTabClicked:function(){this.model.get("active")||this.model.set({active:!0})}}),a.View=d.CollectionView.extend({tagName:"ul",childView:a.ItemView,attributes:{role:"tablist"},collectionEvents:{"change:active change:label":"render"},initialize:function(){this.on("childview:tab:removed",function(a,b){this.collection.remove(b.model)})}})}),POS.module("Components.Tabs",function(a,b,c,d,e,f){a.Model=c.Model.extend({defaults:{label:"&nbsp;",value:"",active:!1,fixed:!0},idAttribute:"value"}),a.Collection=c.Collection.extend({model:a.Model,initialize:function(){this.on("remove",this.onRemove),this.on("change:active",this.onChangeActive)},onRemove:function(){var a=f.compact(this.pluck("active"));f.isEmpty(a)&&this.first().set({active:!0})},onChangeActive:function(a){this.each(function(b){a.id!==b.id&&b.set({active:!1},{silent:!0})})}})}),POS.module("Components.Numpad",function(a,b,c,d,e,f){a.channel=c.Radio.channel("numpad"),a.channel.reply("get:view",function(b){var c=new a.Controller(b);return c.getNumpadView()}),a.channel.comply("show:popover",function(b){var c=new a.Controller(b);c.showNumpadPopover(b)}),a.Controller=d.Controller.extend({initialize:function(b){this.model=new a.Model(b),this.layout=new a.Layout,this.listenTo(this.layout,"show",function(){this._showHeaderRegion(b),this._showKeysRegion(b)}),f.bindAll(this,"_onShowPopover")},getNumpadView:function(){return this.layout},showNumpadPopover:function(a){b.Components.Popover.channel.command("open",{target:a.target,className:"popover numpad-popover",attributes:{role:"textbox"},callback:this._onShowPopover})},getNumpadValue:function(){return this.model.get("value")},_showHeaderRegion:function(c){var d=new a.Header({model:this.model});this.listenTo(d,"enter:keypress",function(){var a=this.model.get("value");a=b.Utils.formatNumber(a,"auto"),c.target.trigger("numpad:return",a,this)}),this.layout.headerRegion.show(d)},_showKeysRegion:function(c){var d=new a.Keys({model:this.model});this.listenTo(d,"return:keypress",function(){var a=this.model.get("value");a=b.Utils.formatNumber(a,"auto"),c.target.trigger("numpad:return",a,this)}),this.layout.keysRegion.show(d)},_onShowPopover:function(a){a.content.show(this.layout)}})}),POS.module("Components.Numpad",function(a,b,c,d,e,f){a.Layout=d.LayoutView.extend({template:f.template('<div class="numpad"><div class="numpad-header"></div><div class="numpad-keys"></div></div>'),regions:{headerRegion:".numpad-header",keysRegion:".numpad-keys"}}),a.Header=b.View.Form.extend({initialize:function(){this.template=a.HeaderTmpl},bindings:{'input[name="value"]':{observe:"value",afterUpdate:function(a){a.trigger("input")}},'input[name="percentage"]':"percentage"},ui:{inputField:"input"},behaviors:{AutoGrow:{}},events:{"keyup @ui.inputField":"directInput","click *[data-modifier]":"modifier"},modelEvents:{"change:mode":"onChangeMode"},modifier:function(a){var b=e(a.currentTarget).data("modifier"),c=this.model.get("value");"quantity"===this.model.get("type")&&this.model.set("value","increase"===b?++c:--c),"discount"===this.model.get("type")&&this.model.set({mode:b})},onChangeMode:function(){this.$("a[data-modifier]").toggleClass("disabled"),this.$("input").toggle()}}),a.Keys=d.ItemView.extend({initialize:function(){this.template=a.NumkeysTmpl},events:{"click .keys a":"onKeyClick"},serializeData:function(){var a=this.model.toJSON();return"tendered"===a.type&&(a.quick_key=this.cashKeys(this.model.get("original"))),a},onKeyClick:function(a){a.preventDefault();var b=e(a.currentTarget),c=b.parent(),d=b.text();return b.hasClass("decimal")?void(this.decimal=!0):c.hasClass("extra-keys discount")?void this.discountKeys(d):c.hasClass("extra-keys tendered")?void this.tenderedKeys(d):(this.standardKeys(d),void(this.decimal=!1))},standardKeys:function(a){var b,c,d={},e=this.model.get("mode"),f=this.model.get("percentage"===e?"percentage":"value");switch(a){case"return":return void this.trigger("return:keypress");case"del":b=Math.abs(f)<10?0:f.toString().slice(0,-1);break;case"+/-":b=-1*f;break;default:f=f.toString(),c=this.decimal&&-1===f.indexOf(".")?".":"",b=f+c+a}d[e]=b,this.model.set(d)},discountKeys:function(a){var b=a.replace("%","");this.model.set({percentage:parseFloat(b),mode:"percentage"})},tenderedKeys:function(a){this.model.set({value:parseFloat(a)})},cashKeys:function(a){var c,d=b.denominations.coins,e=b.denominations.notes,a=parseFloat(a),g=[];return 0===a?e.slice(-4):(f.each(d,function(b){c=f.isEmpty(g)?Math.round(a/b):Math.ceil(a/b),g.push(c*b)}),g=f.uniq(g,!0).slice(0,2),f.each(e,function(b){c=Math.ceil(a/b),g.push(c*b)}),g=f.uniq(g,!0).slice(0,4))}})}),POS.module("Components.Numpad",function(a,b,c,d,e,f){a.Model=c.Model.extend({defaults:{title:"Numpad",value:"0",type:"standard",mode:"value"},initialize:function(a){"money_discount"===a.target.data("numpad")&&(this.on("change:value",this.calcPercentage),this.on("change:percentage",this.calcValue)),this.on("all",function(a){console.log(a)}),this.set({title:a.target.data("title"),type:a.target.data("numpad"),name:a.target.attr("name"),original:a.target.data("original"),value:b.Utils.unformat(a.target.val())})},calcPercentage:function(){var a,c=this.get("original"),d=this.get("value");f.isNaN(d)&&(d=0),a="money_discount"===this.get("type")?100*(1-d/c):100*(d/c),(!f.isFinite(a)||f.isNaN(a))&&(a=0),a=parseFloat(b.Utils.round(a,0)),this.set({percentage:a},{silent:!0})},calcValue:function(){var a,c=this.get("original"),d=this.get("percentage");f.isNaN(d)&&(d=0),a="money_discount"===this.get("type")?c*(1-d/100):c*(d/100),a=parseFloat(b.Utils.round(a)),this.set({value:a},{silent:!0})}})}),POS.module("Components.Numpad",function(a,b,c,d,e){a.Behavior=d.Behavior.extend({initialize:function(){},ui:{input:"*[data-numpad]"},events:{"show:numpad":"numpadPopover","click @ui.input":"numpadPopover","keydown @ui.input":"onBeforeDestroy"},onShow:function(){Modernizr.touch&&this.$("*[data-numpad]").attr("readonly",!0)},numpadPopover:function(b){e(b.target).select(),e(b.target).attr("aria-describedby")||(e("*[data-numpad]").trigger("close:popover"),a.channel.command("show:popover",{target:e(b.target)}),e(b.target).on("numpad:return",function(a,b){e(this).trigger("close:popover"),e(this).val(b).trigger("blur")}))},onBeforeDestroy:function(){this.view.$("*[data-numpad]").trigger("close:popover")}})}),this.POS=this.POS||{},this.POS.Components=this.POS.Components||{},this.POS.Components.Numpad=this.POS.Components.Numpad||{},this.POS.Components.Numpad.HeaderTmpl=Handlebars.template({1:function(a,b,c,d){var e,f=b.helperMissing,g='    <div class="input-group">\n    	<span class="input-group-addon">';return e=(b.getOption||a&&a.getOption||f).call(a,"accounting.currency.symbol",{name:"getOption",hash:{},data:d}),null!=e&&(g+=e),g+'</span>\n		<input type="text" name="value" class="form-control autogrow">\n	</div>\n'},3:function(a,b,c,d){var e,f=b.helperMissing,g='    <span></span>\n	<div class="input-group">\n		<span class="input-group-btn"><a class="disabled" href="#" data-modifier="value">';
return e=(b.getOption||a&&a.getOption||f).call(a,"accounting.currency.symbol",{name:"getOption",hash:{},data:d}),null!=e&&(g+=e),g+'</a></span>\n		<input type="text" name="value" class="form-control autogrow">\n		<input type="text" name="percentage" class="form-control autogrow" style="display:none">\n		<span class="input-group-btn"><a href="#" data-modifier="percentage">%</a></span>\n	</div>\n'},5:function(){return'	<div class="input-group">\n		<span class="input-group-btn"><a href="#" data-modifier="decrease"><i class="icon icon-minus"></i></a></span>\n		<input type="text" name="value" class="form-control autogrow">\n		<span class="input-group-btn"><a href="#" data-modifier="increase"><i class="icon icon-plus"></i></a></span>\n	</div>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f,g="function",h=b.helperMissing,i=this.escapeExpression,j='<strong class="title">'+i((f=null!=(f=b.title||(null!=a?a.title:a))?f:h,typeof f===g?f.call(a,{name:"title",hash:{},data:d}):f))+"</strong>\n\n";return e=(b.is||a&&a.is||h).call(a,null!=a?a.type:a,"price|tendered",{name:"is",hash:{},fn:this.program(1,d),inverse:this.noop,data:d}),null!=e&&(j+=e),j+="\n",e=(b.is||a&&a.is||h).call(a,null!=a?a.type:a,"discount",{name:"is",hash:{},fn:this.program(3,d),inverse:this.noop,data:d}),null!=e&&(j+=e),j+="\n",e=(b.is||a&&a.is||h).call(a,null!=a?a.type:a,"quantity",{name:"is",hash:{},fn:this.program(5,d),inverse:this.noop,data:d}),null!=e&&(j+=e),j},useData:!0}),this.POS.Components.Numpad.NumkeysTmpl=Handlebars.template({1:function(){return'    <div class="keys extra-keys discount">\n        <a href="#" class="btn">5%</a>\n        <a href="#" class="btn">10%</a>\n        <a href="#" class="btn">20%</a>\n        <a href="#" class="btn">25%</a>\n    </div>\n'},3:function(a,b,c,d){var e,f='    <div class="keys extra-keys tendered">\n';return e=b.each.call(a,null!=a?a.quick_key:a,{name:"each",hash:{},fn:this.program(4,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f+"	</div>\n"},4:function(a,b,c,d){var e,f=b.helperMissing,g='        <a href="#" class="btn">';return e=(b.number||a&&a.number||f).call(a,a,{name:"number",hash:{},data:d}),null!=e&&(g+=e),g+"</a>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f=b.helperMissing,g=this.escapeExpression,h='<div class="keys">\n    <div class="row">\n        <a href="#" class="btn">1</a>\n        <a href="#" class="btn">2</a>\n        <a href="#" class="btn">3</a>\n    </div>\n    <div class="row">\n        <a href="#" class="btn">4</a>\n        <a href="#" class="btn">5</a>\n        <a href="#" class="btn">6</a>\n    </div>\n    <div class="row">\n        <a href="#" class="btn">7</a>\n        <a href="#" class="btn">8</a>\n        <a href="#" class="btn">9</a>\n    </div>\n    <div class="row">\n        <a href="#" class="btn">0</a>\n        <a href="#" class="btn">00</a>\n        <a href="#" class="btn decimal">'+g((b.getOption||a&&a.getOption||f).call(a,"accounting.number.decimal",{name:"getOption",hash:{},data:d}))+'</a>\n    </div>\n</div>\n<div class="keys extra-keys standard">\n    <a href="#" class="btn del"><i class="icon icon-delete"><span>del</span></i></a>\n    <a href="#" class="btn">+/-</a>\n    <a href="#" class="btn return">return</a>\n</div>\n\n';return e=(b.is||a&&a.is||f).call(a,null!=a?a.type:a,"discount",{name:"is",hash:{},fn:this.program(1,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h+="\n",e=(b.is||a&&a.is||f).call(a,null!=a?a.type:a,"tendered",{name:"is",hash:{},fn:this.program(3,d),inverse:this.noop,data:d}),null!=e&&(h+=e),h},useData:!0}),POS.module("Components.Select2",function(a,b,c,d,e,f){a.Behavior=d.Behavior.extend({initialize:function(a){this.options=f.defaults(a,{query:f.bind(this.view.query,this.view),formatResult:this.view.formatResult,formatSelection:this.view.formatSelection})},ui:{select:".select2"},onRender:function(){this.ui.select.hasClass("no-search")&&(this.options.dropdownCssClass="no-search"),this.ui.select.select2(this.options)},onBeforeDestroy:function(){this.ui.select.select2("destroy")}})}),POS.module("Components.Customer",function(a,b,c,d,e,f){a.channel=c.Radio.channel("customer"),a.channel.reply("customer:select",function(b){return new a.Select(b)}),a.Select=d.ItemView.extend({template:f.template('<input name="customer" type="hidden" class="select2">'),initialize:function(){},behaviors:{Select2:{minimumInputLength:2,ajax:{url:function(){return b.getOption("ajaxurl")},dataType:"json",quietMillis:250,data:function(a){return{term:a,action:"wc_pos_json_search_customers",security:b.getOption("nonce")}},results:function(a){var b=[];return f(a).each(function(a){b.push(a)}),{results:b}}},initSelection:function(a,c){var d=b.getOption("default_customer");c(d)}}},events:{"change #select-customer":"updateCustomer"},updateCustomer:function(a){this.trigger("customer:select",a.added.id,this.formatSelection(a.added))},formatResult:function(a){var b="";return f.isEmpty(a.first_name)||(b=a.first_name+" "),f.isEmpty(a.last_name)||(b+=a.last_name+" "),""===b&&(b=a.display_name+" "),f.isEmpty(a.user_email)||(b+="("+a.user_email+")"),b},formatSelection:function(a){var b="";return f.isEmpty(a.first_name)||(b=a.first_name+" "),f.isEmpty(a.last_name)||(b+=a.last_name+" "),""===b&&(b=a.display_name),b}})}),POS.module("Components.SearchParser",function(a,b,c,d,e,f){var g="('[^']+'|\"[^\"]+\")",h="('[^']+'|\"[^\"]+\"|[^'\"\\s]\\S*)",i=h+":\\s*",j="",k={ALL_FIELDS:new RegExp(i+h,"g"),CATEGORY:new RegExp(i),parse:function(a){var b=this._extractAllFacets(a);return b},_extractAllFacets:function(a){for(var b={},c=a;a;){var d,e;c=a;var g=this._extractNextField(a);if(g?-1!=g.indexOf(":")?(d=g.match(this.CATEGORY)[1].replace(/(^['"]|['"]$)/g,""),e=g.replace(this.CATEGORY,"").replace(/(^['"]|['"]$)/g,""),a=a.replace(g,"").trim()):-1==g.indexOf(":")&&(d=j,e=g,a=a.replace(e,"").trim()):(d=j,e=this._extractSearchText(a),a=a.replace(e,"").trim()),e&&f(e.split("|")).each(function(a){var c=a.trim().toLowerCase();c&&(b[d]?b[d].push(c):b[d]=[c])}),c==a)break}return b},_extractNextField:function(a){var b=new RegExp("^\\s*(\\S+)\\s+(?="+g+h+")"),c=a.match(b);return c&&c.length>=1?c[1]:this._extractFirstField(a)},_extractFirstField:function(a){var b=a.match(this.ALL_FIELDS);return b&&b.length&&b[0]},_extractSearchText:function(a){a=a||"";var b=a.replace(this.ALL_FIELDS,"").trim();return b},escapeRegExp:function(a){return a.replace(/([.*+?^${}()|[\]\/\\])/g,"\\$1")}};a.channel=c.Radio.channel("search_parser"),a.channel.reply("facets",function(a){return k.parse(a)})}),POS.module("Components.Alerts",function(a,b,c,d,e,f){b.addInitializer(function(){new a.Controller}),a.channel=c.Radio.channel("alerts"),a.Controller=d.Controller.extend({queue:{},initialize:function(){a.channel.comply("open:alert",function(a){this.queueAlert(a)},this),this.on("alert:queued",this.checkQueue),this.on("alert:removed",this.checkQueue)},queueAlert:function(b){var c=new a.View(b);this.queue[c.cid]=c,this.trigger("alert:queued"),this.listenTo(c,"destroy",function(){delete this.queue[c.cid],this.trigger("alert:removed")})},checkQueue:function(){var a=f.find(this.queue,function(a){return a.isOpen}),b=f.find(this.queue,function(a){return f.isUndefined(a.isOpen)});!a&&b&&this.openAlert(b)},openAlert:function(a){a.trigger("alert:open")}})}),POS.module("Components.Alerts",function(a,b,c,d,e,f){a.View=d.ItemView.extend({template:f.template('<a class="action-close" href="#"><i class="icon icon-times"></i></a><% if(title) { %><strong><%= title %></strong><br><% } %><%= message %>'),className:"alert alert-popup",behaviors:{Alerts:{}},triggers:{"click .action-close":"alert:close"},initialize:function(a){f.defaults(a,{type:"info"}),this.$el.addClass("alert-"+a.type)},serializeData:function(){var a={};return a.title=this.getOption("title"),a.message=this.getOption("message"),a}})}),POS.module("Components.Alerts",function(a,b,c,d,e){a.Behavior=d.Behavior.extend({initialize:function(){this.listenToOnce(this.view,"alert:open",this.openAlert),this.listenToOnce(this.view,"alert:close",this.closeAlert)},openAlert:function(){this.view.render(),this.view.$el.fadeIn(500),e("body").append(this.view.$el),this.view.isShown=!0},closeAlert:function(){this.view.$el.fadeOut(500,function(){d.ItemView.prototype.destroy.call(this.view)}.bind(this))}})}),POS.module("HeaderApp",function(a,b,c,d,e,f,g){a.startWithParent=!1,a.channel=c.Radio.channel("header"),a.on("start",function(){{var b=new a.View({el:e("#header")});new a.Menu({el:e("#menu")})}a.channel.comply("open:menu",b.openMenu,b),a.channel.comply("close:menu",b.closeMenu,b)}),a.View=d.ItemView.extend({ui:{menu:"#menu-btn"},events:{"click @ui.menu":"openMenu"},keyEvents:{help:"showHelpModal"},behaviors:{HotKeys:{}},openMenu:function(a){a&&a.preventDefault(),e("body").addClass("menu-open"),this.backdrop=e('<div class="modal-backdrop in"></div>'),this.backdrop.height("100%"),e("body").append(this.backdrop),this.backdrop.on("click",function(){this.closeMenu()}.bind(this))},closeMenu:function(){e("body").removeClass("menu-open"),this.backdrop&&(this.backdrop.remove(),delete this.backdrop)},showHelpModal:function(){new a.HelpModal}}),a.HelpModal=d.ItemView.extend({tagName:"form",behaviors:{Modal:{},Tooltip:{}},initialize:function(){this.template=g.compile(e("#tmpl-wc-pos-help-modal").html()),this.collection=b.Entities.channel.request("hotkeys"),this.title=e("#tmpl-wc-pos-help-modal").data("title"),this.on("button:clicked",this.onButtonClick),this.trigger("modal:open")},serializeData:function(){return{hotkeys:this.collection.toJSON()}},onButtonClick:function(a){e(a.target).hasClass("action-save")&&this.save()},save:function(){var a=c.Syphon.serialize(this);this.collection.set(a),this.collection.save()}}),a.Menu=d.ItemView.extend({events:{"click ul li a":"menuItemClicked"},menuItemClicked:function(){a.channel.command("close:menu")}})},Handlebars),POS.module("POSApp",function(a,b,c,d,e,f){a.startWithParent=!1,a.channel=c.Radio.channel("pos");var g={init:function(){var c=f(b._registry).find(function(b){return b instanceof a.Products.Controller});return c||(c=new a.Products.Controller),c.columnsLayout.rightRegion},cart:function(b){new a.Cart.Controller({id:b,region:this.init()})},checkout:function(b){new a.Checkout.Controller({id:b,region:this.init()})},receipt:function(b){new a.Receipt.Controller({id:b,region:this.init()})}};b.on("before:start",function(){new d.AppRouter({controller:g,appRoutes:{"":"cart",cart:"cart","cart/:id":"cart",checkout:"checkout","checkout/:id":"checkout","receipt/:id":"receipt"}})}),a.channel.comply({"show:cart":function(a){b.navigate(a?"cart/"+a:""),g.cart(a)},"show:checkout":function(a){b.navigate(a?"checkout/"+a:"checkout"),g.checkout(a)},"show:receipt":function(a){b.navigate(a?"receipt/"+a:"receipt"),g.receipt(a)}})}),POS.module("POSApp.Products",function(a,b,c,d,e){a.Controller=b.Controller.Base.extend({initialize:function(){this.columnsLayout=b.layout.mainRegion.twoColumns(this),this.listenTo(this.columnsLayout,"show",function(){this.initProducts()}),this.show(this.columnsLayout,{region:b.layout.mainRegion})},initProducts:function(){this.products=b.Entities.channel.request("products"),this.layout=new a.Layout,b.channel.command("update:tab:label",e("#menu li.products").text(),"left"),this.listenTo(this.layout,"show",function(){var a=new FilteredCollection(this.products);a.hideVariations(),this.showActions(a),this.showTabs(a),this.showProducts(a)}),this.products.once("idb:ready",function(){b.Components.Loading.channel.command("show:loading",this.layout,{region:this.columnsLayout.leftRegion,loading:{entities:this.products.fetch()}})},this)},showActions:function(b){var c=new a.Actions({collection:b});this.listenTo(c,"search:query",function(a){b.query(a)}),this.layout.actionsRegion.show(c)},showTabs:function(a){var c=b.Components.Tabs.channel.request("get:tabs",b.getOption("tabs"));this.listenTo(c.collection,"change:active",function(b){a.query(b.get("value"),"tab")}),this.on("add:new:tab",function(a){c.collection.add(a).set({active:!0})}),this.layout.tabsRegion.show(c)},showProducts:function(c){var d=new a.List({collection:c});this.listenTo(d,"childview:cart:add:clicked",function(a,c){b.POSApp.channel.command("cart:add",c.model)}),this.listenTo(d,"childview:product:variations:clicked",function(a,b){var c={label:b.model.get("title"),value:"parent:"+b.model.get("id"),fixed:!1};this.trigger("add:new:tab",c)}),this.layout.listRegion.show(d)}})}),POS.module("POSApp.Products",function(a,b,c,d,e,f,g){a.Layout=d.LayoutView.extend({template:f.template('<div class="list-actions"></div><div class="list-tabs tabs infinite-tabs"></div><div class="list"></div><div class="list-footer"></div>'),tagName:"section",regions:{actionsRegion:".list-actions",tabsRegion:".list-tabs",listRegion:".list"},attributes:{"class":"module products-module"}}),a.Actions=d.ItemView.extend({initialize:function(){this.template=g.compile(e("#tmpl-products-filter").html())},behaviors:{Filter:{}}}),a.Item=d.ItemView.extend({tagName:"li",className:function(){return this.isVariable()?"variable":void 0},initialize:function(){this.template=g.compile(e("#tmpl-product").html())},ui:{add:".action-add",variations:".action-variations"},triggers:{"click @ui.add":"cart:add:clicked","click @ui.variations":"product:variations:clicked"},onBeforeRender:function(){this.isVariable()&&this.model.set("isVariable",!0)},isVariable:function(){return"variable"===this.model.get("type")?!0:void 0}}),a.Empty=d.ItemView.extend({tagName:"li",className:"empty",template:"#tmpl-products-empty"}),a.List=d.CollectionView.extend({tagName:"ul",className:"striped",childView:a.Item,emptyView:a.Empty,initialize:function(){this.collection.bind("request",this.ajaxStart,this),this.collection.bind("sync",this.ajaxComplete,this)},ajaxStart:function(){this.$el.css({opacity:.5})},ajaxComplete:function(){this.$el.removeAttr("style")}})},Handlebars),POS.module("POSApp.Cart",function(a,b,c,d,e,f){a.Controller=b.Controller.Base.extend({initialize:function(c){this.id=c.id,this.layout=new a.Layout,this.updateTabLabel(),this.listenTo(this.layout,"show",function(){this.showCart(),this.showTotals(),this.showCustomer(),this.showActions(),this.showNotes()}),this.show(this.layout,{region:c.region,loading:{entities:this.getOrders()}}),b.POSApp.channel.comply("cart:add",this.addToCart,this)},getOrders:function(){var a=e.Deferred();return this.orders=b.Entities.channel.request("orders"),this.orders.once("idb:ready",function(){this.orders.fetchLocalOrders()},this),this.orders.once("orders:ready",function(){this.getOrder(this.id)},this),this.on("cart:ready",function(){a.resolve()}),a},getOrder:function(a){this.order=a?this.orders.findWhere({local_id:this.id}):this.orders.length>0?this.orders.at(0):this.orders.add({local_id:""}),this.listenTo(this.order,"change:total",this.updateTabLabel),this.getCart(this.order)},getCart:function(a){this.cart=b.Entities.channel.request("cart",{order:a}),this.cart.once("idb:ready",function(){this.cart.fetchOrder()},this),this.listenTo(this.cart,"cart:ready",function(){this.trigger("cart:ready")})},updateTabLabel:f.debounce(function(a){var c=e("#tmpl-cart").data("title");a&&(c+=" - "+accounting.formatMoney(a.get("total"))),b.channel.command("update:tab:label",c,"right")},100),addToCart:function(a){var d=a instanceof c.Model?a.attributes:a;if(f.isUndefined(this.cart)&&b.debugLog("error","There is no cart"),d.id)var e=this.cart.findWhere({id:d.id});e?e.quantity("increase"):e=this.cart.add(d),e.trigger("focus:row")},showCart:function(){var b=new a.Items({collection:this.cart});this.layout.listRegion.show(b)},showTotals:function(){var b=new a.Totals({model:this.order});this.on("discount:clicked",function(){b.showDiscountRow()}),this.layout.totalsRegion.show(b)},showCustomer:function(){var a=b.Components.Customer.channel.request("customer:select");this.listenTo(a,"customer:select",function(a,b){this.order.save({customer_id:a,customer_name:b})},this),this.layout.customerRegion.on("before:show",function(a){var b=this.$el.html();a.$el.prepend(b)}),this.layout.customerRegion.show(a)},showActions:function(){var c=new a.Actions;this.listenTo(c,"void:clicked",function(){f.invoke(this.cart.toArray(),"destroy")}),this.listenTo(c,"note:clicked",function(){this.trigger("note:clicked")}),this.listenTo(c,"discount:clicked",function(){this.trigger("discount:clicked")}),this.listenTo(c,"fee:clicked",function(a){var c=a.view.$(".action-fee").data("title");b.POSApp.channel.command("cart:add",{title:c,type:"fee"})}),this.listenTo(c,"shipping:clicked",function(a){var c=a.view.$(".action-shipping").data("title");b.POSApp.channel.command("cart:add",{title:c,type:"shipping"})}),this.listenTo(c,"checkout:clicked",function(){b.POSApp.channel.command("show:checkout")}),this.layout.actionsRegion.show(c)},showNotes:function(){var b=new a.Notes({model:this.order});this.on("note:clicked",function(){b.showNoteField()}),this.layout.notesRegion.show(b)}})}),POS.module("POSApp.Cart",function(a,b,c,d,e,f){a.Layout=d.LayoutView.extend({template:f.template(e("#tmpl-cart").html()),tagName:"section",regions:{listRegion:".list",totalsRegion:".list-totals",customerRegion:".cart-customer",actionsRegion:".cart-actions",notesRegion:".cart-notes",footerRegion:".list-footer"},attributes:{"class":"module cart-module"}}),a.Line=d.LayoutView.extend({tagName:"li",className:function(){return this.model.get("type")},template:f.template('<div class="item"></div><div class="drawer"></div>'),regions:{itemRegion:".item",drawerRegion:".drawer"},modelEvents:{"focus:row":"focusRow"},onRender:function(){var b=new a.Line.Item({model:this.model});this.listenTo(b,"drawer:open",this.openDrawer),this.listenTo(b,"drawer:close",this.closeDrawer),this.listenTo(b,"drawer:toggle",function(){this.drawerRegion.hasView()?this.closeDrawer():this.openDrawer()}),this.itemRegion.show(b),this.listenToOnce(this.itemRegion.currentView,"animation:finished",function(){d.ItemView.prototype.remove.call(this)})},remove:function(){},openDrawer:function(){var b=new a.Line.Drawer({model:this.model});this.drawerRegion.show(b),this.$el.addClass("drawer-open")},closeDrawer:function(){this.drawerRegion.empty(),this.$el.removeClass("drawer-open")},focusRow:function(){var a=this,b=this.$el.closest(".list"),c=b.scrollTop(),d=b.position().top,e=b.height()+d,f=this.$el.position().top,g=this.$el.height()+f;d>f&&(c-=d-f),g>e&&(c+=f-b.height()+4),this.$el.addClass("bg-success").closest(".list").animate({scrollTop:c},"fast",function(){("fee"===a.model.get("type")||"shipping"===a.model.get("type"))&&a.$(".title strong.action-edit-title").focus(),a.$el.animate({backgroundColor:"transparent"},500,function(){a.$el.removeClass("bg-success").removeAttr("style")})})}}),a.Line.Item=b.View.Form.extend({initialize:function(){this.template=Handlebars.compile(e("#tmpl-cart-item").html())},templateHelpers:function(){if("incl"===b.getOption("tax").tax_display_cart){var a={};return a.subtotal=this.model.get("subtotal")+this.model.get("subtotal_tax"),a.total=this.model.get("total")+this.model.get("total_tax"),a}},behaviors:{AutoGrow:{},Numpad:{}},ui:{remove:".action-remove",more:".action-more"},events:{"click @ui.remove":"removeItem"},triggers:{"click @ui.more":"drawer:toggle"},bindings:{'input[name="qty"]':{observe:"qty",onGet:function(a){return b.Utils.formatNumber(a,"auto")},onSet:b.Utils.unformat},"strong.action-edit-title":"title",'input[name="item_price"]':{observe:"item_price",onGet:b.Utils.formatNumber,onSet:b.Utils.unformat}},remove:function(){c.Validation.unbind(this),this.$(".action-remove").attr("disabled","true"),this.$el.addClass("bg-danger").parent("ul").addClass("animating"),this.$el.fadeOut(500,function(){this.$el.parent("ul").removeClass("animating"),this.trigger("animation:finished"),d.ItemView.prototype.remove.call(this)}.bind(this))},removeItem:function(){this.model.destroy()}}),a.Line.Drawer=b.View.Form.extend({initialize:function(){this.template=Handlebars.compile(e("#tmpl-cart-item-drawer").html())},behaviors:{AutoGrow:{},Numpad:{}},ui:{addMeta:".action-add-meta",removeMeta:".action-remove-meta",metaLabel:'input[name="meta.label"]',metaValue:'textarea[name="meta.value"]'},events:{"click @ui.addMeta":"addMetaFields","click @ui.removeMeta":"removeMetaFields","blur @ui.metaLabel":"updateMeta","blur @ui.metaValue":"updateMeta"},bindings:{'input[name="regular_price"]':"regular_price",'input[name="taxable"]':"taxable",'select[name="tax_class"]':{observe:"tax_class",selectOptions:{collection:function(){return b.getOption("tax_labels")}}},'select[name="shipping_method"]':{observe:"shipping_method",selectOptions:{collection:function(){return b.getOption("shipping")},comparator:function(){}}}},onShow:function(){this.$el.hide().slideDown(250)},remove:function(){this.$el.slideUp(250,function(){d.ItemView.prototype.remove.call(this)}.bind(this))},updateMeta:function(a){var b=e(a.target),c=b.attr("name").split("."),d=c[0],g=b.val(),h={};if(c.length>1&&"meta"===d){var i=b.parent("span").data("key"),j=this.model.get("meta")||[],k=f.where(j,{key:i});k=k.length>0?k[0]:{key:i},k[c[1]]=g,j.push(k),g=f.uniq(j,"key")}h[d]=g,this.model.save(h)},addMetaFields:function(a){a.preventDefault();var b=e(a.currentTarget).prev("span").data("key"),c=b?b+1:1,d='<input type="text" name="meta.label">',f='<textarea name="meta.value"></textarea>',g='<a href="#" class="action-remove-meta"><i class="icon icon-times"></i></a>';e('<span data-key="'+c+'" />').append(d+f+g).insertBefore(e(a.currentTarget))},removeMetaFields:function(a){a.preventDefault();var b=e(a.currentTarget).parent("span"),c=this.model.get("meta")||[],d=f.findIndex(c,{key:b.data("key")});d>=0&&(c.splice(d,1),this.model.save({meta:c})),b.remove()}}),a.EmptyView=d.ItemView.extend({tagName:"li",className:"empty",template:"#tmpl-cart-empty"}),a.Items=d.CollectionView.extend({tagName:"ul",childView:a.Line,emptyView:a.EmptyView}),a.Totals=d.ItemView.extend({tagName:"ul",initialize:function(){this.template=Handlebars.compile(e("#tmpl-cart-totals").html())},behaviors:{AutoGrow:{},Numpad:{}},modelEvents:{change:"render"},ui:{discount:".order-discount"},events:{"click @ui.discount .total":"edit","keypress @ui.discount input":"saveOnEnter","blur @ui.discount input":"onBlur"},serializeData:function(){var a=this.model.toJSON();return"incl"===b.getOption("tax").tax_display_cart&&(a.subtotal+=a.subtotal_tax,a.cart_discount=a.subtotal-a.total,a.incl_tax=!0),a.original=a.total+a.order_discount,a},edit:function(a){e(a.currentTarget).addClass("editing").children("input").trigger("show:numpad")},save:function(a){var c=e(a.target),d=c.val();return f.isNaN(parseFloat(d))?void c.select():(d&&(d=b.Utils.unformat(d),d=parseFloat(d)),void this.model.save({order_discount:d}))},saveOnEnter:function(a){13===a.which&&(this.save(a),this.model.trigger("change"))},showDiscountRow:function(){this.$(".order-discount").show().children(".total").trigger("click")},onBlur:function(a){void 0===e(a.target).attr("aria-describedby")&&(this.save(a),this.model.trigger("change"))}}),a.Actions=d.ItemView.extend({template:f.template(e("#tmpl-cart-actions").html()),triggers:{"click .action-void":"void:clicked","click .action-note":"note:clicked","click .action-discount":"discount:clicked","click .action-fee":"fee:clicked","click .action-shipping":"shipping:clicked","click .action-checkout":"checkout:clicked"}}),a.Notes=d.ItemView.extend({template:f.template("<%= note %>"),modelEvents:{"change:note":"render"},events:{click:"edit",keypress:"saveOnEnter",blur:"save"},onShow:function(){this.showOrHide()},showOrHide:function(){""===this.model.get("note")&&this.$el.parent(".cart-notes").hide()},edit:function(){this.$el.attr("contenteditable","true").focus()},save:function(){var a=this.$el.text();this.model.save({note:a}),this.$el.attr("contenteditable","false"),this.showOrHide()},saveOnEnter:function(a){13===a.which&&(a.preventDefault(),this.$el.blur())},showNoteField:function(){console.log("show note"),this.$el.parent(".cart-notes").show(),this.$el.attr("contenteditable","true").focus()}})}),POS.module("POSApp.Checkout",function(a,b,c,d,e){a.Controller=b.Controller.Base.extend({initialize:function(c){var d=b.Entities.channel.request("orders");this.layout=new a.Layout,b.channel.command("update:tab:label",e("#tmpl-checkout").data("title"),"right"),this.listenTo(this.layout,"show",function(){this.showCheckout()}),d.once("idb:ready",function(){this.show(this.layout,{region:c.region,loading:{entities:d.fetch({cart:!0})}})},this)},showCheckout:function(){}})}),POS.module("POSApp.Checkout",function(a,b,c,d,e,f){a.Layout=d.LayoutView.extend({template:f.template(e("#tmpl-checkout").html()),tagName:"section",regions:{gatewaysRegion:".checkout-gateways"},attributes:{"class":"module checkout-module"}})}),POS.module("POSApp.Receipt",function(a,b){a.Controller=b.Controller.Base.extend({initialize:function(c){var d=b.Entities.channel.request("orders");this.layout=new a.Layout,this.listenTo(this.layout,"show",function(){this.showReceipt()}),d.once("idb:ready",function(){this.show(this.layout,{region:c.region,loading:{entities:d.fetch({cart:!0})}})},this)},showReceipt:function(){}})}),POS.module("POSApp.Receipt",function(a,b,c,d,e,f){a.Layout=d.LayoutView.extend({template:f.template('<a href="#cart">cart</a>')})}),POS.module("SupportApp",function(a,b,c,d){a.startWithParent=!1,a.channel=c.Radio.channel("support");var e={show:function(){new a.Show.Controller}};POS.on("before:start",function(){new d.AppRouter({controller:e,appRoutes:{support:"show"}})})}),POS.module("SupportApp.Show",function(a,b,c,d,e){a.Controller=b.Controller.Base.extend({initialize:function(){this.layout=b.layout.mainRegion.twoColumns(),this.listenTo(this.layout,"show",function(){this.showForm(),this.showStatus()}),this.show(this.layout,{region:b.layout.mainRegion})},showForm:function(){var b=new a.Form;this.listenTo(b,"send:email",function(a){e.wc_pos_ajax({type:"POST",data:{action:"wc_pos_send_support_email",payload:a}})}),this.layout.leftRegion.show(b)},showStatus:function(){var c=e.wc_pos_ajax({type:"GET",data:{action:"wc_pos_system_status"}}),d=new a.Status(c);b.Components.Loading.channel.command("show:loading",d,{region:this.layout.rightRegion,loading:{entities:c}})}})}),POS.module("SupportApp.Show",function(a,b,c,d,e,f,g){a.Layout=d.LayoutView.extend({template:f.template('<section id="support-form" class="module leftcol"></section><section id="system-status" class="module rightcol"></section>'),regions:{leftRegion:"#support-form",rightRegion:"#system-status"}}),a.Form=d.ItemView.extend({template:"#tmpl-support-form",tagName:"form",attributes:{"class":"module support-module","data-title":"Support Form"},events:{submit:"send"},send:function(a){a.preventDefault();var b=c.Syphon.serialize(this);this.trigger("send:email",b)}}),a.Status=d.ItemView.extend({tagName:"section",attributes:{"class":"module status-module","data-title":"System Status"},initialize:function(a){this.template=g.compile(e("#tmpl-pos-status").html()),this.results=a},serializeData:function(){return this.results.responseJSON}})},Handlebars);
//# sourceMappingURL=maps/app.map